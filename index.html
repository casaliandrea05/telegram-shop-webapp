<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Negozio Online</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      max-width:900px;margin:0 auto;padding:8px 12px;
      background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.08)
    }
    .cart-pill{
      font-weight:700;border-radius:999px;padding:6px 10px;background:#2ea44f;color:#fff
    }
    .actions{margin-top:16px;display:flex;gap:10px;justify-content:center}
    .btn{
      border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:600
    }
    .btn.checkout{background:#2ea44f;color:#fff}
    .btn.clear{background:#eee}
  </style>
</head>
<body>
  <h1>ðŸ›’ Benvenuto nel mio negozio!</h1>
  <p>Scegli un prodotto dal catalogo qui sotto.</p>

  <div class="topbar">
    <div>Carrello: <span id="cartCount" class="cart-pill">0</span></div>
    <div>Totale: <strong id="cartTotal">â‚¬ 0.00</strong></div>
  </div>

  <div id="catalogo" style="margin-top:16px;"></div>

  <div class="actions">
    <button id="checkoutBtn" class="btn checkout">Vai al checkout</button>
    <button id="clearBtn" class="btn clear">Svuota</button>
  </div>

  <script>
    const tg = window.Telegram.WebApp || { sendData: () => {}, showAlert: alert, expand: () => {} };
    tg.expand();

    const cart = []; // {id, name, price, qty}

    function updateCartUI(){
      const count = cart.reduce((s,i)=>s+i.qty,0);
      const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
      document.getElementById('cartCount').textContent = count;
      document.getElementById('cartTotal').textContent = 'â‚¬ ' + total.toFixed(2);
    }

    function addToCart(p){
      const found = cart.find(i => i.id === p.id);
      if(found){ found.qty += 1; }
      else { cart.push({ id:p.id, name:p.nome, price:Number(p.prezzo), qty:1 }); }
      updateCartUI();
      tg.showAlert(`Aggiunto: ${p.nome}`);
    }

    function render(prodotti){
      const container = document.getElementById('catalogo');
      container.innerHTML = '';
      prodotti.forEach(p=>{
        const card = document.createElement('div');
        card.className = 'prodotto';
        card.innerHTML = `
          <h2>${p.nome}</h2>
          <p class="descrizione">${p.descrizione || ''}</p>
          <p class="prezzo">â‚¬ ${Number(p.prezzo).toFixed(2)}</p>
          <div style="display:flex; gap:8px; justify-content:center;">
            <button class="compra">Aggiungi</button>
          </div>
        `;
        card.querySelector('.compra').addEventListener('click', ()=> addToCart(p));
        container.appendChild(card);
      });
    }

    async function caricaProdotti(){
      try{
        const res = await fetch('prodotti.json?v=4', { cache:'no-store' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const prodotti = await res.json();
        render(prodotti);
      }catch(e){
        console.warn('Errore fetch prodotti.json', e);
        const fallback = [
          { id:1, nome:'Maglietta', prezzo:15.00, descrizione:'Cotone 100%' },
          { id:2, nome:'Cappellino', prezzo:10.00, descrizione:'Taglia unica' },
          { id:3, nome:'Felpa', prezzo:29.90, descrizione:'Unisex' }
        ];
        render(fallback);
      }
    }

    document.getElementById('checkoutBtn').addEventListener('click', ()=>{
      if(cart.length === 0){ tg.showAlert('Il carrello Ã¨ vuoto.'); return; }
      const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
      const payload = {
        action: 'checkout',
        items: cart.map(i=>({ id:i.id, name:i.name, price:i.price, qty:i.qty })),
        total: Number(total.toFixed(2))
      };
      tg.sendData(JSON.stringify(payload));
      tg.showAlert('Ordine inviato al bot su Telegram âœ…');
    });

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      cart.length = 0;
      updateCartUI();
      tg.showAlert('Carrello svuotato.');
    });

    updateCartUI();
    caricaProdotti();
  </script>
</body>
</html>
